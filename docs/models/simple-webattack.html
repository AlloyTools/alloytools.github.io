<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="alternate" type="application/rss+xml" title="alloy" href="/feed.xml">
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
  
    
    
    <a class="site-title" href="/">alloy</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
            <a class="page-link" href="/about.html">about</a>
            
          
            
            
          
            
            
          
            
            
            <a class="page-link" href="/applications.html">uses</a>
            
          
            
            
            <a class="page-link" href="/book.html">book</a>
            
          
            
            
          
            
            
          
            
            
            <a class="page-link" href="/community.html">community</a>
            
          
            
            
          
            
            
            <a class="page-link" href="/documentation.html">docs</a>
            
          
            
            
            <a class="page-link" href="/download.html">download</a>
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Web Attacks Intro</h1>
  </header>

  <div class="post-content">
    <h1 id="web-attacks">Web Attacks</h1>

<p>This model shows a store and provides a number of requests to modify the store. It then shows how 
to use the store with a good user <code class="language-plaintext highlighter-rouge">Alice</code> and have a bad user <code class="language-plaintext highlighter-rouge">Eve</code> that do not give any credentials.
Eve should therefore never be able to login or buy anything.</p>

<h2 id="preamble">Preamble</h2>

<p>Order the Token and State sigs which will be used later. (The includes (<code class="language-plaintext highlighter-rouge">open</code>) must come first.)
We also define Item and Token which are needed later but only used for their identity. We
require some of them to be there because otherwise you run into the really nasty problem
that any comprehension seems to succeed because it misses atoms for one of the variables.</p>

<pre><code class="language-alloy">	module store
	open util/ordering[Token] as tk
	open util/ordering[State] as st

	some sig Item, Token {}
</code></pre>

<h2 id="actions">Actions</h2>

<p>We later create a serial trace of actions that are performed in the store. The 
following actions are defined:</p>

<pre><code class="language-alloy">	enum Action { 
		INIT, 
		BUY, 
		LOGIN, 
		STUTTER 
	}
</code></pre>

<p>The <code class="language-plaintext highlighter-rouge">STUTTER</code> action is necessary to not block the trace. I.e. if there are no more items and 
everybody is logged in then there are no alternative actions so then stutter can fill the gap.</p>

<h2 id="authentication">Authentication</h2>

<p>We use a simple userid to digest table. The <code class="language-plaintext highlighter-rouge">digest</code> (total) function calculates a digest. In this case
we use the same atom for ease of use but this should be a one-way hash function like the SHA-x
algorithm.</p>

<p>We add the credentials for Alice but no credentials for Eve. That is, Eve has no access to the 
store.</p>

<pre><code class="language-alloy">	fun digest[password : String ] : String { password }

	pred authenticate[userid,password : String] {
		userid-&gt;digest[password] in 
			("Alice" -&gt; digest["Bob123"]) 
	}
</code></pre>

<h2 id="state">State</h2>

<p>We need to create a trace of actions. We maintain this state in, ehh, <code class="language-plaintext highlighter-rouge">State</code>. For convenience
this State maintains the state for both the browser (the cookies) and the server (the stock,
token generator, etc.).</p>

<p>Notice that the order is very relevant here because it defines how the sig is displayed in the
table view. You should try to create ‘sentences’ with the order. For example, <code class="language-plaintext highlighter-rouge">Eve BUY item</code></p>

<p>It is important to realize that the cookies are <em>shared state</em>. This means that the browser is free 
to ignore or violete the contract of cookies. We can therefore not create any facts that rely in the 
cookies.</p>

<pre><code class="language-alloy">	sig State {

		browser		: lone Browser,
		action		: Action,
		bought		: lone Item,

		// Reflects the browser state

		cookies		: Browser -&gt; Token,

		// Reflects the server state

		stock		: set Item,
		cart		: Token -&gt; (Item+String),
		token		: lone Token,
		nextToken	: Token,
	}
</code></pre>
<h2 id="action-predicates">Action Predicates</h2>

<p>Later we define a trace of actions. A trace is a sequence of State atoms. We require
that the trace is constrained by the action predicates. That is, going from State<sup>n</sup> to
State<sup>n+1</sup> requires that one of the action predicates is <code class="language-plaintext highlighter-rouge">true</code>.</p>

<h2 id="login">Login</h2>

<p>The first action predicate is <code class="language-plaintext highlighter-rouge">login</code>. A browser gives us a userid and a password. These credentials
must be authenticated before the login succeeds.</p>

<p>If this login is successful then we require a cookie with a <em>token</em>. 
This token is a capability, a browser that has that token can then
buy in the store.</p>

<p>The login fails if the user is already logged in. It might be interesting
to succeed a failed attempt due to lack of proper credentials. This would then
record the attack in the trace. That is not done here.</p>

<p>In the cart we record the user id as the first <em>bought</em> item, this is a bit hackish. 
It records the name of the user of that cart, but it also creates at least one entry in
the cart. I.e. it <em>activates</em> the cart. (Never realized you could hack in models?)</p>

<pre><code class="language-alloy">
	pred login[ s, s' : lone State ] {
		let 	browser = s'.browser, 
			userid = browser.userid,
			password = browser.password {

			one userid
			one password
			no s.cart.userid
			authenticate[ userid,password ] 

			s'.action = LOGIN
			s'.nextToken = s.nextToken.next
			s'.stock = s.stock
			s'.cart = s.cart + (s.nextToken-&gt;userid)
			s'.token = s.nextToken
			s'.bought = none	
			s'.cookies = s.cookies + (browser-&gt;s.nextToken)
		}
	}
</code></pre>

<h2 id="buy">Buy</h2>

<p>After login the browser has a cookie with a token. We use this token to record
the sale in the corresponding cart.</p>

<pre><code class="language-alloy">
	pred buy[ s, s' : State ] {
		let 	item 	= s'.bought, 
			tkn 	= s'.token {

			some item
			item in s.stock 
	
			one tkn
			some s.cart[tkn]
	
			s'.action = BUY
			s'.nextToken = s.nextToken
			s'.stock = s.stock-item
			s'.cart = s.cart + (tkn -&gt; item)
			s'.token = tkn
			s'.bought = item
	
			s'.cookies = s.cookies
		}
	}
</code></pre>

<h2 id="stutter">Stutter</h2>

<p>A stutter action is there to fill gaps. If the trace cannot make progress then it can always
provide a stutter step. They are kind of annoying because a trace with just stutters is
then a perfectly valid solution. You have to filter out those solutions with your <code class="language-plaintext highlighter-rouge">run</code> command.
For <code class="language-plaintext highlighter-rouge">check</code> commands they are generally irrelevant.</p>

<pre><code class="language-alloy">
	pred stutter[s, s' : State ] {

		s'.action = STUTTER
		s'.nextToken = s.nextToken
		s'.stock = s.stock
		s'.cart = s.cart
		s'.browser = none
		s'.token = none
		s'.bought = none

		s'.cookies = s.cookies
	}		

</code></pre>

<h2 id="the-clients">The Clients</h2>

<p>We’re now ready to define the client side. Our model is that we have a <em>Browser</em>, 
a.k.a the <em>User Agent</em>.</p>

<p>We’re cheating a bit because we do not record the cookies in the browser, we rely 
on the shared state to store the cookies. (This is dangerous because it is 
now easy to make facts that assume the server knows about the browser.)</p>

<p>We are also definining two users: Alice and Eve. Alice is the good girl and gets a password. Eve is evil
and we do not constrain her use of credentials. In practice, this means that Alloy will use all
possible credentials for Eve.</p>

<pre><code class="language-alloy">	abstract sig Browser {
		userid : String,
		password : String
	}

	one sig Alice extends Browser {} {
		userid = "Alice"
		password = "Bob123"
	}
	one sig Eve extends Browser {}
</code></pre>

<h2 id="trace">Trace</h2>
<p>We now create a trace of every combination of all possible actions. We constrain
the actions to those allowed by the action predicates <code class="language-plaintext highlighter-rouge">login</code>, <code class="language-plaintext highlighter-rouge">buy</code>, and <code class="language-plaintext highlighter-rouge">stutter</code>.</p>

<p>That is, each action predicate is used to constrain State<sup>n</sup> -&gt; State<sup>n+1</sup></p>

<pre><code class="language-alloy">	fact {

		st/first.nextToken = tk/first
		st/first.stock = Item
		no st/first.bought
		no st/first.cart
		no st/first.browser
		no st/first.cookies
		st/first.action = INIT

		all s' : State - first, s : s'.prev {

				login[s,s']
			or 
				buy[s,s']
			or
				stutter[s,s']

		}
	}
</code></pre>

<h2 id="checking">Checking</h2>

<p>We do not want Eve to be able to buy anything, only Alice’s credentials are recorded
in the password database so Eve should not be able to login nor buy anything.</p>

<p>So we can check that Eve can never buy anything nor can she login:</p>

<pre><code class="language-alloy">        assert Evil {
		no s : State | s.browser = Eve
	}
	check Evil for 4
</code></pre>

<p>If we run this then it gives us the following output.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┏━━━━━━━━━━┳━━━━━━━┳━━━━━━━━┳━━━━━━┳━━━━━━━━━━━┳━━━━━┳━━━━━━━━━━━━━━┳━━━━━━┳━━━━━━━━━┓
┃this/State┃browser┃action  ┃bought┃cookies    ┃stock┃cart          ┃token ┃nextToken┃
┠──────────╊━━━━━━━╋━━━━━━━━╋━━━━━━╋━━━━━━━━━━━╋━━━━━╋━━━━━━━━━━━━━━╋━━━━━━╋━━━━━━━━━┫
┃State⁰    ┃       ┃INIT⁰   ┃      ┃           ┃Item⁰┃              ┃      ┃Token⁰   ┃
┠──────────╊━━━━━━━╋━━━━━━━━╋━━━━━━╋━━━━━━━━━━━╋━━━━━╋━━━━━━━━━━━━━━╋━━━━━━╋━━━━━━━━━┫
┃State¹    ┃       ┃STUTTER⁰┃      ┃           ┃Item⁰┃              ┃      ┃Token⁰   ┃
┠──────────╊━━━━━━━╋━━━━━━━━╋━━━━━━╋━━━━━━━━━━━╋━━━━━╋━━━━━━━━━━━━━━╋━━━━━━╋━━━━━━━━━┫
┃State²    ┃       ┃STUTTER⁰┃      ┃           ┃Item⁰┃              ┃      ┃Token⁰   ┃
┠──────────╊━━━━━━━╋━━━━━━━━╋━━━━━━╋━━━━┯━━━━━━╋━━━━━╋━━━━━━┯━━━━━━━╋━━━━━━╋━━━━━━━━━┫
┃State³    ┃Eve⁰   ┃LOGIN⁰  ┃      ┃Eve⁰│Token⁰┃Item⁰┃Token⁰│"Alice"┃Token⁰┃Token¹   ┃
┗━━━━━━━━━━┻━━━━━━━┻━━━━━━━━┻━━━━━━┻━━━━┷━━━━━━┻━━━━━┻━━━━━━┷━━━━━━━┻━━━━━━┻━━━━━━━━━┛
</code></pre></div></div>

<p>You can see this also in the Browser table. We see that Eve has stolen the credentials
of Alice.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┏━━━━━━━━━━━━┳━━━━━━━┳━━━━━━━━┓
┃this/Browser┃userid ┃password┃
┠────────────╊━━━━━━━╋━━━━━━━━┫
┃Alice⁰      ┃"Alice"┃"Bob123"┃
┠────────────╊━━━━━━━╋━━━━━━━━┫
┃Eve⁰        ┃"Alice"┃"Bob123"┃
┗━━━━━━━━━━━━┻━━━━━━━┻━━━━━━━━┛
</code></pre></div></div>

<h2 id="attacks">Attacks</h2>

<p>This is a bit of a conumdrum but it shows the power of Alloy. This immediately shows how 
fragile passwords are. In the real world we demand from the users that they keep their 
passwords secret. We therefore record this (stupid!) assumption in a fact.</p>

<pre><code class="language-alloy">
	fact NoSharedPassword {
	//	all disj b1, b2 : Browser | b1.userid = b2.userid =&gt; b1.password != b2.password
	}
</code></pre>
<p>Uncomment the previous fact and the run the EveBuying command again. This gives the following output</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┏━━━━━━━━━━┳━━━━━━━┳━━━━━━━━┳━━━━━━┳━━━━━━━━━━━━━┳━━━━━┳━━━━━━━━━━━━━━┳━━━━━━┳━━━━━━━━━┓
┃this/State┃browser┃action  ┃bought┃cookies      ┃stock┃cart          ┃token ┃nextToken┃
┠──────────╊━━━━━━━╋━━━━━━━━╋━━━━━━╋━━━━━━━━━━━━━╋━━━━━╋━━━━━━━━━━━━━━╋━━━━━━╋━━━━━━━━━┫
┃State⁰    ┃       ┃INIT⁰   ┃      ┃             ┃Item⁰┃              ┃      ┃Token⁰   ┃
┠──────────╊━━━━━━━╋━━━━━━━━╋━━━━━━╋━━━━━━━━━━━━━╋━━━━━╋━━━━━━━━━━━━━━╋━━━━━━╋━━━━━━━━━┫
┃State¹    ┃       ┃STUTTER⁰┃      ┃             ┃Item⁰┃              ┃      ┃Token⁰   ┃
┠──────────╊━━━━━━━╋━━━━━━━━╋━━━━━━╋━━━━━━┯━━━━━━╋━━━━━╋━━━━━━┯━━━━━━━╋━━━━━━╋━━━━━━━━━┫
┃State²    ┃Alice⁰ ┃LOGIN⁰  ┃      ┃Alice⁰│Token⁰┃Item⁰┃Token⁰│"Alice"┃Token⁰┃Token¹   ┃
┠──────────╊━━━━━━━╋━━━━━━━━╋━━━━━━╋━━━━━━┿━━━━━━╋━━━━━╋━━━━━━┿━━━━━━━╋━━━━━━╋━━━━━━━━━┫
┃State³    ┃Eve⁰   ┃BUY⁰    ┃Item⁰ ┃Alice⁰│Token⁰┃     ┃Token⁰│"Alice"┃Token⁰┃Token¹   ┃
┃          ┠───────╂────────╂──────╂──────┴──────┨     ┃      ├───────╂──────╂─────────┨
┃          ┃       ┃        ┃      ┃             ┃     ┃      │Item⁰  ┃      ┃         ┃
┗━━━━━━━━━━┻━━━━━━━┻━━━━━━━━┻━━━━━━┻━━━━━━━━━━━━━┻━━━━━┻━━━━━━┷━━━━━━━┻━━━━━━┻━━━━━━━━━┛
</code></pre></div></div>

<p>Since Eve can no longer succeed in using Alice’s credentials, it tries to steal the token that the
server handed to Alice’s browser. It can do this by sniffing in on a wireless network at
Starbucks when Alice uses normal HTTP, not encrypted HTTPS.</p>

<p>It is interesting to see that the item ends up in Alice’s cart.</p>

<p>So we need to record a fact that our model can assume that in the real world the cookies are
protected using HTTPS and cannot be guessed. In our model that means we can ‘trust’ the
cookies to be protected. (Another indication of the fragility of the web.)</p>

<p>Again uncomment for making it active.</p>

<pre><code class="language-alloy">	fact HTTPS {
	//	all s : State | one s.token implies s.token = s.cookies[s.browser]
	}
</code></pre>

<p>Instead of doing a run, we now want to make sure Eve cannot buy anything ever … So if you
run the check again it should fail to find a counter example.</p>

<p>So now we know the web is safe! <code class="language-plaintext highlighter-rouge">#not</code></p>


  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

	<table  style="border:none; color:#CCC">
		<colgroup>
			<col style="witdh:33%"/>
			<col style="witdh:34%"/>
			<col style="witdh:33%"/>
		</colgroup>
		<tr>
			<td  style="border:none;text-align:left;">© 2019 AlloyTools</td>
			<td style="border:none;text-center;"><a href="https://groups.google.com/forum/#!forum/alloytools">Forum</a></td>
			<td style="border:none;text-align:right;">
				<a href="https://github.com/AlloyTools"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">AlloyTools</span></a>

			</td>			
		</tr>
	</table>

</footer>


  </body>

</html>
